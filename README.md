# AI Media Generator

A full-stack web application that integrates with Runware.com and Replicate.com APIs for AI-powered photo and video generation, with Thai payment system integration via Omise.

## Features

### 🎨 AI Generation
- **Image Generation**: Create stunning images using Runware (fast & cheap) or Replicate (high quality)
- **Video Generation**: Generate short videos from text prompts using Replicate
- **Multiple Models**: Access to FLUX Schnell, Stable Diffusion, and more
- **Real-time Processing**: Fast generation with status tracking

### 💳 Payment System
- **Thai Payment Methods**: 
  - Credit/Debit Cards (Visa, Mastercard)
  - PromptPay QR Code
  - TrueMoney Wallet
- **Credit Packages**:
  - Starter Pack: ฿350 (1000 credits)
  - Basic Pack: ฿850 (2500 credits) - Most Popular
  - Pro Pack: ฿1,650 (5000 credits)
  - Premium Pack: ฿3,200 (10000 credits)
- **30% Markup**: Automatic 30% markup on API costs included in pricing

### 🔔 Notifications
- **LINE Notify**: Automatic notifications when new users sign up
- Real-time alerts for admin monitoring

### 🔐 Authentication
- Email/Password login
- Social login (Google, Facebook) via Manus OAuth
- Secure session management

### 📊 Database
- User management with roles (user/admin)
- Credit balance tracking
- Transaction history
- Generation history with cost tracking

## Tech Stack

### Frontend
- **React 19** with TypeScript
- **Tailwind CSS 4** for styling
- **shadcn/ui** components
- **Wouter** for routing
- **tRPC** for type-safe API calls

### Backend
- **Node.js** with Express
- **tRPC 11** for API layer
- **Drizzle ORM** with MySQL/TiDB
- **Omise SDK** for payments

### APIs
- **Runware API**: Fast, cost-effective image generation
- **Replicate API**: High-quality image and video generation
- **LINE Notify API**: Push notifications

## Project Structure

```
ai-media-generator/
├── client/                 # Frontend React application
│   ├── src/
│   │   ├── pages/         # Page components
│   │   │   ├── Home.tsx   # Landing page
│   │   │   ├── Generate.tsx  # Generation interface
│   │   │   └── Credits.tsx   # Payment/credits page
│   │   ├── components/    # Reusable UI components
│   │   ├── lib/          # tRPC client setup
│   │   └── const.ts      # Constants and config
├── server/                # Backend Node.js application
│   ├── routers.ts        # tRPC API routes
│   ├── db.ts             # Database connection
│   ├── dbHelpers.ts      # Database query helpers
│   ├── runware.ts        # Runware API integration
│   ├── replicate.ts      # Replicate API integration
│   ├── omise.ts          # Omise payment integration
│   └── lineNotify.ts     # LINE notification helper
├── drizzle/              # Database schema and migrations
│   └── schema.ts         # Database tables definition
└── storage/              # S3 storage helpers

```

## Environment Variables

The following environment variables are automatically configured:

```env
# Database
DATABASE_URL=<mysql-connection-string>

# Authentication
JWT_SECRET=<auto-generated>
VITE_APP_ID=<manus-app-id>
OAUTH_SERVER_URL=<manus-oauth-url>
VITE_OAUTH_PORTAL_URL=<manus-portal-url>

# API Keys (Need to be configured)
RUNWARE_API_KEY=<your-runware-api-key>
REPLICATE_API_KEY=<your-replicate-api-key>

# Payment Gateway (Need to be configured)
OMISE_PUBLIC_KEY=<your-omise-public-key>
OMISE_SECRET_KEY=<your-omise-secret-key>

# Notifications (Already configured)
LINE_NOTIFY_TOKEN=<your-line-notify-token>

# App Branding
VITE_APP_TITLE=AI Media Generator
VITE_APP_LOGO=<logo-url>
```

## API Endpoints (tRPC)

### Authentication
- `auth.me` - Get current user
- `auth.logout` - Logout user

### Credits
- `credits.getBalance` - Get user credit balance
- `credits.getTransactions` - Get transaction history

### Generations
- `generations.list` - Get generation history
- `generations.generateImage` - Generate image (Runware or Replicate)
- `generations.generateVideo` - Generate video (Replicate)

### Payments
- `payments.getPackages` - Get available credit packages
- `payments.createPayment` - Create payment charge
- `payments.checkPaymentStatus` - Check payment status

## Database Schema

### Users Table
- `id`: User ID (primary key)
- `name`: User name
- `email`: User email
- `loginMethod`: Authentication method
- `role`: User role (user/admin)
- `createdAt`: Account creation timestamp
- `lastSignedIn`: Last sign-in timestamp

### Credits Table
- `userId`: User ID (foreign key)
- `balance`: Credit balance in cents
- `createdAt`: Record creation timestamp
- `updatedAt`: Last update timestamp

### Transactions Table
- `id`: Transaction ID (primary key)
- `userId`: User ID (foreign key)
- `type`: Transaction type (purchase/usage/refund)
- `amount`: Amount in cents
- `balanceAfter`: Balance after transaction
- `description`: Transaction description
- `paymentMethod`: Payment method used
- `paymentId`: Omise charge ID
- `paymentStatus`: Payment status
- `createdAt`: Transaction timestamp

### Generations Table
- `id`: Generation ID (primary key)
- `userId`: User ID (foreign key)
- `provider`: API provider (runware/replicate)
- `type`: Generation type (text_to_image/text_to_video/etc.)
- `prompt`: Text prompt used
- `model`: Model used
- `parameters`: Additional parameters (JSON)
- `status`: Generation status (pending/processing/completed/failed)
- `resultUrl`: URL of generated media
- `errorMessage`: Error message if failed
- `apiCost`: Actual API cost in cents
- `userCost`: Cost charged to user in cents (with markup)
- `processingTime`: Processing time in seconds
- `createdAt`: Generation start timestamp
- `completedAt`: Generation completion timestamp

## Cost Structure

### API Costs (Base)
- **Runware Image**: ~$0.0013 per image (~0.13 cents)
- **Replicate Image (FLUX Schnell)**: ~$0.003 per image (~0.3 cents)
- **Replicate Video**: ~$0.50 per video (~50 cents)

### User Costs (with 30% markup)
- **Runware Image**: ~1-2 credits per image
- **Replicate Image**: ~3-5 credits per image
- **Replicate Video**: ~65 credits per video

## Setup Instructions

### 1. Configure Omise Payment Gateway

To enable payments, you need to set up an Omise account:

1. Sign up at [https://omise.co](https://omise.co)
2. Get your API keys from the dashboard
3. Add the keys to your environment variables:
   - `OMISE_PUBLIC_KEY`: Your public key
   - `OMISE_SECRET_KEY`: Your secret key

### 2. Database Migration

The database schema is already set up. If you need to make changes:

```bash
# Edit schema
vim drizzle/schema.ts

# Push changes to database
pnpm db:push
```

### 3. Running the Application

```bash
# Install dependencies (already done)
pnpm install

# Run development server
pnpm dev

# The app will be available at the provided URL
```

## Usage Guide

### For Users

1. **Sign Up/Login**: Click "Get Started Free" or "Sign In"
2. **Buy Credits**: Go to Credits page and purchase a credit package
3. **Generate Content**:
   - Go to Generate page
   - Choose Image or Video tab
   - Enter your prompt
   - Select provider (Runware for speed, Replicate for quality)
   - Click Generate
4. **Download**: Once generated, download your content

### For Admins

- **Monitor Sign-ups**: Receive LINE notifications when users sign up
- **Track Usage**: View generation history and costs in the database
- **Manage Credits**: Manually adjust user credits if needed via database

## Payment Flow

1. User selects a credit package
2. User chooses payment method (card/PromptPay/TrueMoney)
3. For cards: Omise.js tokenizes card details client-side
4. For PromptPay/TrueMoney: System generates QR code or redirect
5. Payment is processed via Omise
6. Upon success, credits are added to user account
7. Transaction is recorded in database

## Generation Flow

1. User enters prompt and selects provider
2. System checks user credit balance
3. API call is made to Runware or Replicate
4. Cost is calculated with 30% markup
5. Credits are deducted from user account
6. Generation record is saved with result URL
7. User can download the generated content

## Security Features

- **API Keys**: Stored securely in environment variables, never exposed to client
- **Payment Tokens**: Card details tokenized client-side via Omise.js
- **Authentication**: Secure session management with JWT
- **Role-based Access**: Admin vs user permissions
- **Input Validation**: All inputs validated via Zod schemas

## Monitoring & Notifications

### LINE Notifications
When a new user signs up, you'll receive a LINE notification with:
- User name
- User email
- Login method
- Timestamp (Bangkok timezone)

### Transaction History
All transactions are logged with:
- User ID
- Transaction type
- Amount
- Payment method
- Payment ID
- Status
- Timestamp

## Troubleshooting

### Payment Issues
- Verify Omise API keys are correct
- Check if payment method is supported in your region
- Review Omise dashboard for failed transactions

### Generation Failures
- Check API key validity
- Verify user has sufficient credits
- Review error messages in generation history
- Check API provider status pages

### LINE Notifications Not Working
- Verify LINE_NOTIFY_TOKEN is correct
- Check token permissions in LINE Notify settings
- Review server logs for notification errors

## Future Enhancements

Potential features to add:
- Image editing (inpainting, outpainting, upscaling)
- Batch generation
- Generation templates/presets
- User galleries
- Social sharing
- Referral program
- Subscription plans
- Admin dashboard UI
- Payment webhooks for async processing

## Support

For issues or questions:
- Check the troubleshooting section
- Review server logs
- Contact support at [https://help.manus.im](https://help.manus.im)

## License

This project is built using the Manus platform and includes integrations with third-party APIs (Runware, Replicate, Omise, LINE).

---

**Built with ❤️ using Manus, Runware, and Replicate APIs**
